# Задача: Аудит безопасности и внедрение защитных механизмов

## I. Общая цель

Провести комплексный аудит безопасности существующего API, выявить и устранить потенциальные уязвимости, а также внедрить превентивные защитные меры, включая ограничение частоты запросов (rate limiting), для повышения общей отказоустойчивости и защищённости сервиса.

---

## II. Аудит уязвимостей (Vulnerability Assessment)

AI-агент должен систематически проанализировать **все существующие эндпоинты** и внутреннюю логику на предмет следующих распространённых уязвимостей:

### 1. Аутентификация и авторизация:
-   **Проверка прав доступа**: Убедиться, что пользователь не может получить или изменить данные, принадлежащие другому пользователю (проверка на **IDOR** - Insecure Direct Object References). Например, запрос `DELETE /profile/me/tags/{tagId}` должен провалиться, если `tagId` не принадлежит текущему авторизованному пользователю.
-   **Защита эндпоинтов**: Перепроверить, что все эндпоинты, требующие аутентификации, корректно её проверяют и не пропускают запросы без валидного `access_token`.
-   **Безопасность токенов**: Проанализировать логику выхода из системы (`logout`). Убедиться, что отозванный `refresh_token` не может быть использован повторно.

### 2. Валидация входящих данных:
-   **Инъекции (Injection Attacks)**: Проверить все эндпоинты, принимающие пользовательский ввод (`POST`, `PUT`, `GET` с параметрами), на уязвимости к SQL-инъекциям (если используется SQL) или NoSQL-инъекциям. Весь ввод должен быть строго валидирован и/или санирован.
-   **Межсайтовый скриптинг (XSS)**: Убедиться, что данные, которые могут отображаться в клиентских приложениях (например, `displayName`, `bio`, `text` тегов), проходят санизацию для предотвращения сохранения и выполнения вредоносных скриптов.

### 3. Обработка ошибок:
-   **Утечка информации**: Проверить, что в случае ошибок (например, `500 Internal Server Error`) API не возвращает в ответе чувствительную информацию (трассировку стека, пути к файлам, SQL-запросы). Ответы должны быть общими и информативными только для клиента.

---

## III. Внедрение защитных механизмов

На основе аудита и общих практик безопасности, AI-агент должен реализовать следующие меры:

### 1. Ограничение частоты запросов (Rate Limiting)

-   **Цель**: Защита от **Brute-force атак** (подбор паролей) и **DoS-атак** (отказ в обслуживании).
-   **Требования к реализации**:
    -   Внедрить глобальный rate-limit для всех IP-адресов (например, не более 100 запросов в минуту на один IP).
    -   Внедрить более строгий rate-limit для чувствительных эндпоинтов:
        -   `POST /auth/login`: не более 5-10 попыток в минуту на один IP.
        -   `POST /auth/register`: не более 5 запросов в час на один IP.
        -   `POST /auth/refresh`: не более 20-30 запросов в час на один IP.
    -   При превышении лимита API должен возвращать ошибку `429 Too Many Requests`.

### 2. Усиление валидации и санизации

-   **Действие**: На всех эндпоинтах, принимающих данные, внедрить строгие правила валидации (например, с использованием Pydantic для FastAPI, или аналогичных библиотек).
-   **Правила**:
    -   Проверка на максимальную длину строк (`displayName`, `bio`).
    -   Проверка формата для `handle` (только разрешённые символы, нижний регистр).
    -   Проверка типа загружаемых файлов для аватара (только изображения, например, `jpeg`, `png`) и их максимального размера.
    -   Санировать все текстовые поля перед сохранением в базу данных для нейтрализации HTML-тегов и скриптов.

### 3. Безопасные HTTP-заголовки

-   **Действие**: Настроить бэкенд так, чтобы он отправлял клиенту безопасные HTTP-заголовки для защиты от атак на стороне браузера.
-   **Обязательные заголовки**:
    -   `Content-Security-Policy (CSP)`: Задать строгую политику, ограничивающую источники для скриптов, стилей и т.д.
    -   `X-Content-Type-Options`: `nosniff`.
    -   `X-Frame-Options`: `SAMEORIGIN` или `DENY`.
    -   `Strict-Transport-Security (HSTS)`: Обеспечить использование HTTPS.
    -   Настроить **CORS**, чтобы разрешать запросы только с доверенных доменов.

---

## IV. Логирование (Logging)

-   **Действие**: Обеспечить, чтобы система вела журналы (логи) всех событий, связанных с безопасностью.
-   **Что логировать**:
    -   Неудачные попытки входа (`login`).
    -   Запросы на сброс/изменение пароля.
    -   Срабатывание rate-limit'ов (с указанием IP-адреса).
    -   Попытки доступа к защищённым ресурсам с невалидным токеном.

---

## V. Итоговый отчёт

По завершении работы AI-агент должен предоставить краткий отчёт, включающий:
1.  Список найденных уязвимостей (если таковые были).
2.  Перечень внедрённых защитных мер (rate-лимиты, валидация, заголовки).
3.  Рекомендации по дальнейшему улучшению безопасности, если это необходимо.